---
title: "Vaccination and Delta Viral Load"
author: "Brian Yandell"
date: "8/4/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

This build on work of the [AIDS Vaccine Research Laboratory](https://dholk.primate.wisc.edu/project/dho/public/manuscripts/published/viral-loads-in-vaccinees/begin.view?) for the manuscript [https://www.medrxiv.org/content/10.1101/2021.07.31.21261387v1](Vaccinated and unvaccinated individuals have similar viral loads in communities with a high prevalence of the SARS-CoV-2 delta variant).

```{r}
library(tidyverse)
library(readxl)
```

```{r}
datadir <- "https://dholk.primate.wisc.edu/_webdav/dho/public/manuscripts/published/viral-loads-in-vaccinees/%40files"
```

```{r}
tmpfile <- tempfile()
download.file(
  file.path(datadir, "N1_Ct_values.xlsx"), tmpfile)
n1ct <- read_excel(tmpfile, na = c("", "NA"))
unlink(tmpfile)
rm(tmpfile)
```

```{r}
n1ct <- n1ct %>%
  mutate(Variant = (Pango == "B.1.617.2") & !is.na(Pango),
         Variant = c("Other", "Delta")[1 + Variant],
         Variant = ifelse(is.na(Pango), "Unknown", Variant),
         Viral_Load = 2^(30 - N1),
         Delta = Variant,
         Delta = ifelse(Delta != "Delta", "Other/Variant", Delta),
         Location = "Wisconsin") %>%
  rename(Vaccinated = "Fully Vaccinated")
```

Would be helpful to identify to county, but HIPAA privacy restrictions prevents that.
Otherwise `Location` column could be modified to "Dane Co" and "Other Co", for instance.

```{r}
ggplot(n1ct) +
  aes(Vaccinated, N1, col = Pango) +
  geom_boxplot(col = "gray") +
  geom_jitter(width = 0.2) +
  facet_grid(Location ~ Variant) +
  scale_y_continuous(sec.axis = sec_axis(~ 2^(30-.), name = "Viral Load",
                                         breaks = c(1,10,100, 1000, 10000)))
```

Test for variant and vaccinated effects. Use location if more than one.

```{r}
if(n1ct %>% count(Location) %>% nrow() > 1) {
  fit <- lm(N1 ~ Location * Variant * Vaccinated, n1ct)
} else {
  fit <- lm(N1 ~  Variant * Vaccinated, n1ct)
}
```

```{r}
drop1(fit, fit, test = "F")
```

Test for variant and vaccinated effects in samples with sequenced variant. Use location if more than one.

```{r}
n1ctna <- n1ct %>% filter(!is.na(Pango))
if(n1ct %>% count(Location) %>% nrow() > 1) {
  fitna <- lm(N1 ~ Location * Variant * Vaccinated, n1ctna)
} else {
  fitna <- lm(N1 ~  Variant * Vaccinated, n1ctna)
}
```

```{r}
drop1(fitna, fitna, test = "F")
```

## August 10 Symptom Dataset

```{r}
tmpfile <- tempfile()
download.file(
  file.path(datadir, "10Aug2021_N1_Ct_toshare.xlsx"), tmpfile)
n1ctb <- read_excel(tmpfile, na = c("", "NA"))
unlink(tmpfile)
rm(tmpfile)
```

```{r}
n1ctb <- n1ctb %>%
  select(1:3) %>%
  rename(N1 = "N1_Ct",
         Vaccinated = "Fully Vaccinated") %>%
  mutate(AnySymptoms = ifelse(is.na(AnySymptoms), NA, paste(AnySymptoms, "Symptoms")))
```

```{r}
ggplot(n1ctb ) +
  aes(Vaccinated, N1) +
  geom_boxplot(col = "gray") +
  geom_jitter(width = 0.2) +
  facet_grid(~ AnySymptoms) +
  scale_y_continuous(sec.axis = sec_axis(~ 2^(30-.), name = "Viral Load",
                                         breaks = c(1,10,100, 1000, 10000)))
```

Assume that identical N1 and Vaccinated are same samples.

```{r}
n1ctc <- 
  full_join(
    n1ct,
    n1ctb,
    by = c("N1","Vaccinated"))
```

```{r}
ggplot(n1ctc %>% 
         filter(!is.na(AnySymptoms),
                !is.na(Variant))) +
  aes(Vaccinated, N1, col = Pango) +
  geom_boxplot(col = "gray") +
  geom_jitter(width = 0.2) +
  facet_grid(AnySymptoms~ Variant) +
  scale_y_continuous(sec.axis = sec_axis(~ 2^(30-.), name = "Viral Load",
                                         breaks = c(1,10,100, 1000, 10000)))
```

